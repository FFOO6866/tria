# Alertmanager Configuration for TRIA AI-BPO
# ===========================================
#
# Routes alerts to appropriate channels (PagerDuty, Slack, Email)

global:
  resolve_timeout: 5m
  # Slack webhook (optional)
  slack_api_url: '${SLACK_WEBHOOK_URL}'

  # PagerDuty integration key (optional)
  pagerduty_url: 'https://events.pagerduty.com/v2/enqueue'

# Alert routing
route:
  # Default receiver for all alerts
  receiver: 'default'

  # Group alerts by alertname and severity
  group_by: ['alertname', 'severity', 'component']

  # Wait before sending notification (collect multiple alerts)
  group_wait: 30s

  # Wait before sending about new alerts in the same group
  group_interval: 5m

  # Wait before re-sending resolved alerts
  repeat_interval: 4h

  # Sub-routes for different severity levels
  routes:
    # Critical alerts ‚Üí PagerDuty (page on-call)
    - match:
        severity: critical
      receiver: 'pagerduty-critical'
      continue: true  # Also send to Slack

    # Critical alerts ‚Üí Slack #alerts channel
    - match:
        severity: critical
      receiver: 'slack-alerts'

    # Warning alerts ‚Üí Slack #monitoring channel
    - match:
        severity: warning
      receiver: 'slack-monitoring'

    # Cost alerts ‚Üí Slack #finance channel
    - match:
        component: cost
      receiver: 'slack-finance'

# Alert receivers (notification channels)
receivers:
  # Default (email)
  - name: 'default'
    email_configs:
      - to: '${ALERT_EMAIL:-ops@tria.com}'
        from: '${ALERT_FROM_EMAIL:-alerts@tria.com}'
        smarthost: '${SMTP_HOST:-smtp.gmail.com:587}'
        auth_username: '${SMTP_USER}'
        auth_password: '${SMTP_PASSWORD}'
        headers:
          Subject: '[TRIA ALERT] {{ .GroupLabels.alertname }}'
        html: |
          <h2>Alert: {{ .GroupLabels.alertname }}</h2>
          <p><strong>Severity:</strong> {{ .GroupLabels.severity }}</p>
          <p><strong>Component:</strong> {{ .GroupLabels.component }}</p>
          <p><strong>Summary:</strong> {{ .CommonAnnotations.summary }}</p>
          <p><strong>Description:</strong> {{ .CommonAnnotations.description }}</p>
          <p><strong>Runbook:</strong> <a href="{{ .CommonAnnotations.runbook }}">{{ .CommonAnnotations.runbook }}</a></p>

  # PagerDuty (critical alerts only)
  - name: 'pagerduty-critical'
    pagerduty_configs:
      - service_key: '${PAGERDUTY_SERVICE_KEY}'
        severity: '{{ .GroupLabels.severity }}'
        description: '{{ .CommonAnnotations.summary }}'
        details:
          firing: '{{ .Alerts.Firing | len }}'
          resolved: '{{ .Alerts.Resolved | len }}'
          description: '{{ .CommonAnnotations.description }}'
          runbook: '{{ .CommonAnnotations.runbook }}'

  # Slack #alerts (critical)
  - name: 'slack-alerts'
    slack_configs:
      - channel: '#alerts'
        color: 'danger'
        title: 'üö® {{ .GroupLabels.alertname }} ({{ .GroupLabels.severity }})'
        text: |
          *Component:* {{ .GroupLabels.component }}
          *Summary:* {{ .CommonAnnotations.summary }}
          *Description:* {{ .CommonAnnotations.description }}
          *Runbook:* {{ .CommonAnnotations.runbook }}
          *Firing:* {{ .Alerts.Firing | len }} | *Resolved:* {{ .Alerts.Resolved | len }}

  # Slack #monitoring (warnings)
  - name: 'slack-monitoring'
    slack_configs:
      - channel: '#monitoring'
        color: 'warning'
        title: '‚ö†Ô∏è  {{ .GroupLabels.alertname }} ({{ .GroupLabels.severity }})'
        text: |
          *Component:* {{ .GroupLabels.component }}
          *Summary:* {{ .CommonAnnotations.summary }}
          *Description:* {{ .CommonAnnotations.description }}

  # Slack #finance (cost alerts)
  - name: 'slack-finance'
    slack_configs:
      - channel: '#finance'
        color: 'warning'
        title: 'üí∞ {{ .GroupLabels.alertname }}'
        text: |
          *Cost Alert:* {{ .CommonAnnotations.summary }}
          *Details:* {{ .CommonAnnotations.description }}
          *Action:* {{ .CommonAnnotations.action }}

# Inhibition rules (suppress alerts when related alerts are firing)
inhibit_rules:
  # Suppress all warnings if API is down (critical)
  - source_match:
      severity: 'critical'
      alertname: 'APIDown'
    target_match:
      severity: 'warning'
    equal: ['component']

  # Suppress cache warnings if Redis is down
  - source_match:
      alertname: 'CacheUnavailable'
    target_match:
      component: 'cache'
    equal: ['component']

  # Suppress DB warnings if DB is down
  - source_match:
      alertname: 'DatabaseDown'
    target_match:
      component: 'database'
    equal: ['component']
